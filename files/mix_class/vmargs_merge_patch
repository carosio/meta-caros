#!/bin/zsh
#
#This script patches the boot file generated by exrm
#such that vmargs_merge is used to merge the generated
#vm.args file with the options given in a config file.
#See vmargs_merge file for a more detailed description.

BOOT_FILE_PATH=$1
REPLACE_CONTENT=' \
#######################################	\
## PATCH \
source $RELEASE_CONFIG_DIR/vmargs_merge	\
#######################################	\
'
#Get top number of line range we want to comment out
PATCH_LINE_NR=$(grep -rne '\"$RELEASE_CONFIG_DIR/vm.args\" \"$GENERATED_CONFIG_DIR/vm.args\"' \
                $BOOT_FILE_PATH | gawk '{print $1}' FS=":")
PATCH_LINE_NR=$((PATCH_LINE_NR - 1)) #needs to be decremented to be the top line
sed -i'' "$((PATCH_LINE_NR)),$((PATCH_LINE_NR+2)) s/^/#/" $BOOT_FILE_PATH
sed -i "$((PATCH_LINE_NR+3))i$REPLACE_CONTENT" $BOOT_FILE_PATH
